---
layout: default
title: edReject
parent: OMG Tools
nav_order: 94
---
# edReject

## Description
`edReject` is a specialized utility for automatically flagging spurious soundings within OMG-HDCS merged files using "Ed's method". This method focuses on detecting various types of "spikes" or sudden discontinuities in the depth profile across the swath, such as simple spikes, or flat-topped/bottomed spikes.

The tool calculates depth gradients (`delta`) between adjacent beams and flags beams where these gradients exceed a user-defined threshold (`eps`) or show specific patterns indicative of spikes.

## Usage
```bash
edReject <mergefile(s)> [-v] [-eps <value>]
```

## Arguments

| Option | Description |
|---|---|
| `<mergefile(s)>` | **Required.** One or more paths to OMG-HDCS merged files to be processed. These files are modified in place. |
| `-v` | Enable verbose output (present in the `main` function arguments but not explicitly used in the provided code snippet). |
| `-eps <value>` | (Present in `USAGE` but commented out in `main`'s argument parsing) Intended to specify the epsilon threshold for depth gradients. Default `0.1` is hardcoded in the `Eds_method` function. | `0.1` |

## How It Works
1.  **File Processing:** The tool iterates through each provided merged file.
2.  **Summary Header Reading:** Reads the summary header for basic file information.
3.  **Profile Iteration:** For each profile (ping) in the file:
    *   Reads the current `profile` header and raw `beams`.
    *   **Data Preparation:** Populates an `abeam` array (`allbeams`) with the `acrossTrack` and `observedDepth` values (converted to meters) for each beam.
    *   **Ed's Method Application:** Calls the `Eds_method` function to perform the core spike detection logic:
        *   **Gradient Calculation:** For each beam `i` (from 1 to `nodepths - 1`), it calculates `allbeams[i].delta` as the depth difference between `allbeams[i]` and `allbeams[i-1]`, divided by the absolute across-track difference.
        *   **Spike Detection Rules:** It then iterates through the beams and applies various rules based on `allbeams[i].delta` and its neighbors to identify spikes:
            *   **Spikes close to zero:** Flags beams adjacent to zero-depth readings if their `delta` exceeds `eps`.
            *   **Simple spikes:** Flags `beam_flags[i]` (using bitwise OR) if `allbeams[i].delta` is positive and `allbeams[i+1].delta` is negative (spike up then down), or vice-versa.
            *   **Spikes with high flat:** Flags `beam_flags[i]` if `allbeams[i].delta` is a strong positive/negative gradient, followed by a flat section, and then a strong negative/positive gradient.
        *   **Target Detection (Commented Out):** There's a section for "Target detection" that attempts to set `*profile_flag = 'T'` if any `beam_flags[i]` is non-zero and has adjacent non-zero flags. This part is currently not fully implemented or utilized to update the `profile.edflag`.
    *   **Flagging & Storing:** The flags generated by `Eds_method` (stored in `flags` array) are assigned to `beams[i].calibratedBackscatter`. The `profile.edflag` is also updated.
    *   **Write Back:** The modified `profile` header and `beams` are written back to the merged file.

## Output
*   The `profile.edflag` is set to 'T' if targets are detected, otherwise it is '0'.
*   The `beams[i].calibratedBackscatter` field is used to store the individual beam flags generated by Ed's method (0 for good, non-zero for flagged).

## Notes
*   The `Eds_method` uses bitwise flags (`|=`) to mark different types of spikes in the `beam_flags` array (e.g., `1`, `2`, `4`, `8`, `16`, `32`, `64`, `128`).
*   The `epsilon` threshold (`eps`) for detecting spikes is hardcoded to `0.1` within the `Eds_method` function.
*   The argument parsing for `-eps` is commented out in `main`, meaning the hardcoded `0.1` will always be used.
*   The use of `beams[i].calibratedBackscatter` to store internal flags suggests that this field is repurposed for debugging or diagnostic purposes by this tool.
